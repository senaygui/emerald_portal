<% provide(:title, "Dashboard") %>
<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>Dashboard</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </div>
    </div>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12 col-md-8">

        <!-- Profile Image -->
        <div class="card card-primary profile-card shadow-lg animate__animated animate__fadeInDown">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h3 class="card-title"><i class="fas fa-user-graduate mr-2 animate__animated animate__tada animate__infinite"></i>My Profile</h3>
          </div>
          <div class="card-body box-profile">
            <div class="text-center mb-2">
              <% if current_student.photo.attached? %>
                <%= image_tag(current_student.photo, size: '150x150', class: "profile-user-img img-fluid rounded-circle border border-primary shadow-sm animate__animated animate__zoomIn") %>
              <% else %>
                <%= image_tag("blank-profile-picture-973460_640.png", size: '150x150', class: "profile-user-img img-fluid img-circle border border-secondary shadow-sm animate__animated animate__zoomIn") %>
              <% end %>
            </div>
            <h3 class="profile-username text-center mb-1"><b><%= "#{current_student.first_name.upcase} #{current_student.middle_name.upcase} #{current_student.last_name.upcase}" %></b></h3>
            <p class="text-center text-muted mb-3" style="font-size:1.1rem;">Welcome back, <%= current_student.first_name.capitalize %>!</p>
            <div class="row text-center mb-3">
              <div class="col-3">
                <div class="stat-card" data-toggle="tooltip" title="Total Courses Registered">
                  <i class="fas fa-book fa-2x text-primary"></i>
                  <div class="stat-value" id="courses-count"><%= current_student.course_registrations.count %></div>
                  <div class="stat-label">Courses</div>
                </div>
              </div>
              <div class="col-3">
                <div class="stat-card" data-toggle="tooltip" title="Total Invoices">
                  <i class="fas fa-file-invoice-dollar fa-2x text-success"></i>
                  <div class="stat-value" id="invoices-count"><%= current_student.invoices.count %></div>
                  <div class="stat-label">Invoices</div>
                </div>
              </div>
              <div class="col-3">
                <div class="stat-card" data-toggle="tooltip" title="Total Payments Made">
                  <i class="fas fa-coins fa-2x text-warning"></i>
                  <div class="stat-value" id="payments-count"><%= current_student.invoices.where(invoice_status: 'approved').count %></div>
                  <div class="stat-label">Paid</div>
                </div>
              </div>
              <div class="col-3">
                <div class="stat-card" data-toggle="tooltip" title="Total Unpaid Invoices">
                  <i class="fas fa-exclamation-circle fa-2x text-danger"></i>
                  <div class="stat-value" id="unpaid-count"><%= current_student.invoices.where(invoice_status: 'pending').count %></div>
                  <div class="stat-label">Unpaid</div>
                </div>
              </div>
            </div>
            <ul class="list-group list-group-unbordered mb-3">
              <li class="list-group-item">
                <b><i class="fas fa-id-card mr-1"></i>Student Fullname</b> <a class="text-muted float-right"><%= current_student.full_name %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-hashtag mr-1"></i>Student ID</b> <a class="text-muted float-right"><%= current_student.student_id.present? ? current_student.student_id : "Not Assigned Yet" %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-venus-mars mr-1"></i>Gender</b> <a class="text-muted float-right"><%= current_student.gender %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-birthday-cake mr-1"></i>Date Of Birth</b> <a class="text-muted float-right"><%= current_student.date_of_birth.present? ? current_student.date_of_birth.strftime("%b %d, %Y") : "N/A" %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-envelope mr-1"></i>Email</b> <a class="text-muted float-right"><%= current_student.email %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-graduation-cap mr-1"></i>Program</b> <a class="text-muted float-right"><%= current_student.program&.program_name || "N/A" %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-users mr-1"></i>Batch</b> <a class="text-muted float-right"><%= current_student.batch&.batch_title || "N/A" %></a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <%= render 'instruction' %>
    
        <div class="card card-warning contact-card animate__animated animate__fadeInRight mb-3">
          <div class="card-header d-flex align-items-center justify-content-between" style="background: #ffe082;">
            <h3 class="card-title"><i class="fas fa-address-book mr-2 text-warning"></i>Contact Address Information</h3>
          </div>
          <div class="card-body box-profile">
            <ul class="list-group list-group-unbordered mb-3">
              <li class="list-group-item">
                <b><i class="fas fa-mobile-alt mr-1 text-warning"></i>Mobile Number</b> <a class="text-muted float-right"><%= current_student.moblie_number %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-flag mr-1 text-warning"></i>Country</b> <a class="text-muted float-right"><%= current_student.country %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-city mr-1 text-warning"></i>City</b> <a class="text-muted float-right"><%= current_student.city %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-map-marker-alt mr-1 text-warning"></i>Region</b> <a class="text-muted float-right"><%= current_student.region.present? ? current_student.region : "N/A" %></a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Account Information Card -->
        <div class="card card-info account-card animate__animated animate__fadeInUp mt-3">
          <div class="card-header d-flex align-items-center justify-content-between" style="background: #b3e5fc; color: #212529;">
            <h3 class="card-title"><i class="fas fa-user-shield mr-2 text-info"></i>Account Information</h3>
          </div>
          <div class="card-body box-profile">
            <ul class="list-group list-group-unbordered mb-3">
              <li class="list-group-item">
                  <b><i class="fas fa-user-check mr-1 text-info"></i>Account Status</b>
                  <% status = current_student.account_status %>
                  <% badge_class = case status
                    when 'active' then 'badge-success'
                    when 'inactive' then 'badge-secondary'
                    when 'suspended' then 'badge-danger'
                    else 'badge-light'
                  end %>
                  <span class="float-right badge <%= badge_class %> animate__animated animate__pulse animate__infinite" style="font-size: 1rem; min-width: 90px; text-transform: capitalize;">
                    <%= status %>
                  </span>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-graduation-cap mr-1 text-info"></i>Graduation Status</b> <a class="text-muted float-right"><%= current_student.graduation_status.present? ? current_student.graduation_status : "N/A" %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-user-clock mr-1 text-info"></i>Fully Attended</b> <a class="text-muted float-right"><%= current_student.fully_attended %></a>
              </li>
              <li class="list-group-item">
                <b><i class="fas fa-calendar-check mr-1 text-info"></i>Fully Attended Date</b> <a class="text-muted float-right"><%= current_student.fully_attended_date.present? ? current_student.fully_attended_date.strftime("%b %d, %Y") : "N/A" %></a>
              </li>
            </ul>
          </div>
        </div>
<style>
  .contact-card {
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(255,193,7,0.10);
    border: 2px solid #ffe082;
    transition: box-shadow 0.25s, border 0.25s;
  }
  .contact-card:hover {
    box-shadow: 0 8px 24px rgba(255,193,7,0.18);
    border-color: #ffc107;
  }
  .account-card {
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.10);
    border: 2px solid #b3e5fc;
    transition: box-shadow 0.25s, border 0.25s;
  }
  .account-card:hover {
    box-shadow: 0 8px 24px rgba(33,150,243,0.18);
    border-color: #039be5;
  }
</style>
      </div>
    </div>


  </div>
</section>

<style>
  .profile-card {
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0,0,0,0.12);
    transition: box-shadow 0.3s;
  }
  .profile-card:hover {
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  }
  .profile-user-img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 50%;
    border: 4px solid #007bff;
    background: #fff;
    margin-bottom: 0.5rem;
  }
  .stat-card {
    background: linear-gradient(135deg, #f8f9fa 60%, #e3f0ff 100%);
    border-radius: 16px;
    padding: 1rem 0.5rem 0.75rem 0.5rem;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    transition: transform 0.25s, box-shadow 0.25s, background 0.25s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    border: 2px solid #e3f0ff;
    min-height: 120px;
  }
  .stat-card:hover {
    transform: translateY(-5px) scale(1.06) rotate(-1deg);
    box-shadow: 0 8px 24px rgba(0,123,255,0.18);
    background: linear-gradient(135deg, #e3f0ff 60%, #f8f9fa 100%);
    border-color: #007bff;
  }
  .stat-card .fa-2x {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.10));
    margin-bottom: 0.25rem;
    transition: color 0.2s;
  }
  .stat-card:hover .fa-2x {
    color: #0056b3 !important;
  }
  .stat-value {
    font-size: 2.1rem;
    font-weight: 800;
    color: #007bff;
    margin-top: 0.15rem;
    margin-bottom: 0.1rem;
    letter-spacing: 1px;
    transition: color 0.2s;
  }
  .stat-card:hover .stat-value {
    color: #0056b3;
  }
  .stat-label {
    font-size: 1.05rem;
    color: #6c757d;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-top: 0.1rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }
  .stat-card::after {
    content: '';
    position: absolute;
    right: -30px;
    top: -30px;
    width: 60px;
    height: 60px;
    background: rgba(0,123,255,0.08);
    border-radius: 50%;
    z-index: 0;
    transition: background 0.2s;
  }
  .stat-card:hover::after {
    background: rgba(0,123,255,0.18);
  }
<script>
  // Animated counter for stat values
  document.addEventListener('DOMContentLoaded', function() {
    function animateValue(id, start, end, duration) {
      var obj = document.getElementById(id);
      if (!obj) return;
      var range = end - start;
      var minTimer = 30;
      var stepTime = Math.abs(Math.floor(duration / range));
      stepTime = Math.max(stepTime, minTimer);
      var startTime = new Date().getTime();
      var endTime = startTime + duration;
      function run() {
        var now = new Date().getTime();
        var remaining = Math.max((endTime - now) / duration, 0);
        var value = Math.round(end - (remaining * range));
        obj.textContent = value;
        if (value == end) return;
        requestAnimationFrame(run);
      }
      run();
    }
    animateValue('courses-count', 0, parseInt(document.getElementById('courses-count').textContent), 900);
    animateValue('invoices-count', 0, parseInt(document.getElementById('invoices-count').textContent), 900);
    animateValue('payments-count', 0, parseInt(document.getElementById('payments-count').textContent), 900);
    animateValue('unpaid-count', 0, parseInt(document.getElementById('unpaid-count').textContent), 900);
  });
</script>
  .instruction-card {
    border: 4px solid;
    border-radius: 10px;
    animation: borderColorCycle 2.5s linear infinite;
  }
  @keyframes borderColorCycle {
    0%   { border-color: #28a745; }
    33%  { border-color: #ffc107; }
    66%  { border-color: #e53935; }
    100% { border-color: #28a745; }
  }
  .clickable-link {
    color: #007bff;
    text-decoration: underline;
    cursor: pointer;
  }
  .clickable-link:hover {
    color: #0056b3;
  }
</style>

<!-- FontAwesome & Animate.css CDN for icons and animation -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <% if current_student.graduation_status.to_s == 'graduated' %>
    <!-- Fireworks/Confetti on graduation -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
    (function setupGradConfetti() {
      function stopConfetti() {
        if (window._gradConfettiInterval) {
          clearInterval(window._gradConfettiInterval);
          window._gradConfettiInterval = null;
        }
      }

      function startConfetti() {
        try {
          stopConfetti();
          var duration = 30000; // 3min
          var animationEnd = Date.now() + duration;
          window._gradConfettiInterval = setInterval(function () {
            var timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) {
              stopConfetti();
              return;
            }
            confetti({
              particleCount: 100,
              startVelocity: 55,
              spread: 70,
              gravity: 1.0,
              ticks: 200,
              origin: { x: Math.random(), y: 1.02 }
            });
          }, 250);
        } catch (e) {
          // no-op if confetti fails to load
        }
      }

      // Fire on initial load and on Turbo/Turbolinks navigations
      var fire = function () { startConfetti(); };
      document.addEventListener('DOMContentLoaded', fire);
      document.addEventListener('turbolinks:load', fire);
      document.addEventListener('turbo:load', fire);
      // Clean up before Turbo caches the page
      document.addEventListener('turbo:before-cache', stopConfetti);
    })();
    </script>
  <% end %>
<script>
  // Tooltip initialization for stat cards
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (el) {
      el.addEventListener('mouseenter', function() {
        var title = el.getAttribute('title');
        if (title) {
          var tooltip = document.createElement('div');
          tooltip.className = 'custom-tooltip';
          tooltip.innerText = title;
          document.body.appendChild(tooltip);
          var rect = el.getBoundingClientRect();
          tooltip.style.left = (rect.left + window.scrollX + rect.width/2 - tooltip.offsetWidth/2) + 'px';
          tooltip.style.top = (rect.top + window.scrollY - tooltip.offsetHeight - 8) + 'px';
          el._tooltip = tooltip;
        }
      });
      el.addEventListener('mouseleave', function() {
        if (el._tooltip) {
          document.body.removeChild(el._tooltip);
          el._tooltip = null;
        }
      });
    });
  });
</script>
<style>
  .custom-tooltip {
    position: absolute;
    background: #343a40;
    color: #fff;
    padding: 0.4em 0.8em;
    border-radius: 6px;
    font-size: 0.95rem;
    z-index: 9999;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    opacity: 0.95;
    transition: opacity 0.2s;
  }
</style>
